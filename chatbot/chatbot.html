<!DOCTYPE html>
<html lang="en" class="h-100">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
	<title>AI Chatbot</title>

	<!-- Favicons -->
	<link rel="icon" type="image/png" sizes="32x32" href="favicons/favicon-16x16.png">
	<link rel="icon" type="image/png" sizes="16x16" href="favicons/favicon-16x16.png">
	<link rel="apple-touch-icon" sizes="180x180" href="favicons/apple-touch-icon.png">
	<link rel="icon" type="image/x-icon" href="favicons/favicon.ico">
	<link rel="manifest" href="favicons/site.webmanifest">

	<!-- Bootstrap CSS -->
	<link href="bootstrap-5.3.8-dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Bootstrap Icons -->
	<link href="bootstrap-icons-1.13.1/bootstrap-icons.css" rel="stylesheet">
	<!-- Google Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

	<style>
		/* Custom Scrollbar */
		.scrollbar-custom::-webkit-scrollbar {
			width: 6px;
			height: 6px;
			background-color: transparent;
		}

		.scrollbar-custom::-webkit-scrollbar-track {
			background-color: transparent;
		}

		.scrollbar-custom::-webkit-scrollbar-thumb {
			background-color: rgba(0, 0, 0, 0.1);
			border-radius: 9999px;
		}

		.scrollbar-custom:hover::-webkit-scrollbar-thumb {
			background-color: rgba(0, 0, 0, 0.2);
		}

		.dark .scrollbar-custom::-webkit-scrollbar-thumb {
			background-color: rgba(255, 255, 255, 0.1);
		}

		.dark .scrollbar-custom:hover::-webkit-scrollbar-thumb {
			background-color: rgba(255, 255, 255, 0.2);
		}

		/* Utilities */
		html,
		body {
			overscroll-behavior: none;
			touch-action: pan-x pan-y;
		}

		body {
			font-family: 'Inter', sans-serif;
		}

		/* Typing indicator animation */
		.typing-indicator {
			display: inline-flex;
			align-items: center;
		}

		.typing-dot {
			animation: typing 1.4s infinite ease-in-out;
		}

		.typing-dot:nth-child(1) {
			animation-delay: -0.32s;
		}

		.typing-dot:nth-child(2) {
			animation-delay: -0.16s;
		}

		@keyframes typing {

			0%,
			80%,
			100% {
				transform: scale(0);
			}

			40% {
				transform: scale(1);
			}
		}

		/* Chat specific styles */
		.chat-message {
			max-width: 85%;
		}

		@media (min-width: 768px) {
			.chat-message {
				max-width: 70%;
			}
		}

		/* Markdown content styling */
		.markdown-content {
			line-height: 1.6;
		}

		.markdown-content h1,
		.markdown-content h2,
		.markdown-content h3,
		.markdown-content h4,
		.markdown-content h5,
		.markdown-content h6 {
			margin-top: 1.5rem;
			margin-bottom: 0.5rem;
			font-weight: 600;
		}

		.markdown-content h1 {
			font-size: 1.5rem;
		}

		.markdown-content h2 {
			font-size: 1.25rem;
		}

		.markdown-content h3 {
			font-size: 1.125rem;
		}

		.markdown-content p {
			margin-bottom: 1rem;
		}

		.markdown-content p:last-child {
			margin-bottom: 0;
		}

		.markdown-content ul,
		.markdown-content ol {
			margin-bottom: 1rem;
			padding-left: 1.5rem;
		}

		.markdown-content li {
			margin-bottom: 0.25rem;
		}

		.markdown-content code {
			background-color: rgba(0, 0, 0, 0.1);
			padding: 0.125rem 0.25rem;
			border-radius: 0.25rem;
			font-size: 0.875em;
		}

		.dark .markdown-content code {
			background-color: rgba(255, 255, 255, 0.1);
		}

		.markdown-content pre {
			background-color: rgba(0, 0, 0, 0.1);
			padding: 1rem;
			border-radius: 0.5rem;
			overflow-x: auto;
			margin-bottom: 1rem;
		}

		.dark .markdown-content pre {
			background-color: rgba(255, 255, 255, 0.1);
		}

		.markdown-content pre code {
			background-color: transparent;
			padding: 0;
		}

		.markdown-content blockquote {
			border-left: 4px solid #dee2e6;
			padding-left: 1rem;
			margin-bottom: 1rem;
			font-style: italic;
		}

		.dark .markdown-content blockquote {
			border-left-color: #495057;
		}

		.markdown-content table {
			width: 100%;
			border-collapse: collapse;
			margin-bottom: 1rem;
		}

		.markdown-content th,
		.markdown-content td {
			border: 1px solid #dee2e6;
			padding: 0.5rem;
			text-align: left;
		}

		.dark .markdown-content th,
		.dark .markdown-content td {
			border-color: #495057;
		}

		.markdown-content th {
			background-color: rgba(0, 0, 0, 0.05);
			font-weight: 600;
		}

		.dark .markdown-content th {
			background-color: rgba(255, 255, 255, 0.05);
		}
	</style>
</head>

<body class="h-100 bg-white dark bg-dark text-dark dark text-light transition-colors duration-200">

	<!-- App Container -->
	<div class="position-fixed top-0 start-0 w-100 h-100 overflow-hidden"
		style="display: grid; grid-template-columns: 1fr; grid-template-rows: 1fr;">
		<div id="app-grid" class="d-flex w-100 h-100">

			<!-- Sidebar (Desktop & Mobile Drawer) -->
			<nav id="sidebar" class="d-none d-md-flex flex-column h-100 bg-light dark bg-dark border-end border-secondary"
				style="width: 280px;">
				<!-- Header -->
				<div class="d-flex align-items-center justify-content-between p-3 sticky-top" style="z-index: 10;">
					<a href="#" class="d-flex align-items-center gap-2 rounded-3 p-2 text-decoration-none fw-bold"
						style="font-size: 1.125rem;">
						<!-- Logo -->
						<svg class="bi text-dark" width="28" height="28" viewBox="0 0 32 32" fill="currentColor"
							xmlns="http://www.w3.org/2000/svg">
							<path
								d="M16.0006 25.9992C13.8266 25.999 11.7118 25.2901 9.97686 23.9799C8.2419 22.6698 6.98127 20.8298 6.38599 18.7388C5.79071 16.6478 5.89323 14.4198 6.678 12.3923C7.46278 10.3648 8.88705 8.64837 10.735 7.50308C12.5829 6.35779 14.7538 5.84606 16.9187 6.04544C19.0837 6.24481 21.1246 7.14442 22.7323 8.60795C24.34 10.0715 25.4268 12.0192 25.8281 14.1559C26.2293 16.2926 25.9232 18.5019 24.9561 20.449C24.7703 20.8042 24.7223 21.2155 24.8211 21.604L25.4211 23.8316C25.4803 24.0518 25.4805 24.2837 25.4216 24.5039C25.3627 24.7242 25.2468 24.925 25.0856 25.0862C24.9244 25.2474 24.7235 25.3633 24.5033 25.4222C24.283 25.4811 24.0512 25.4809 23.831 25.4217L21.6034 24.8217C21.2172 24.7248 20.809 24.7729 20.4558 24.9567C19.0683 25.6467 17.5457 26.0068 16.0006 26.0068V25.9992Z" />
						</svg>
						AI Chatbot
					</a>
					<button class="btn btn-outline-secondary btn-sm" onclick="createNewChat()">
						New Chat
					</button>
				</div>

				<!-- Conversation List -->
				<div class="flex-grow-1 overflow-auto scrollbar-custom p-3 pt-2">
					<div class="text-xs fw-semibold text-muted mb-2 mt-2 px-2">Conversations</div>
					<div id="conversation-list">
						<!-- Conversations will be loaded here -->
					</div>
				</div>

				<!-- Footer (Settings & Theme) -->
				<div class="mt-auto border-top border-secondary p-3 d-grid gap-2">
					<button onclick="toggleTheme()" class="btn btn-link btn-sm text-decoration-none text-muted">
						<i class="bi bi-sun-fill me-2"></i>
						<span id="theme-text">Toggle Theme</span>
					</button>
					<button onclick="showSettings()" class="btn btn-link btn-sm text-decoration-none text-muted">
						<i class="bi bi-gear-fill me-2"></i>
						Settings
					</button>
				</div>
			</nav>

			<!-- Mobile Header (Visible only on mobile) -->
			<div
				class="d-md-none position-fixed top-0 start-0 w-100 d-flex align-items-center justify-content-between px-3 border-bottom border-secondary"
				style="height: 56px; z-index: 20;">
				<button onclick="toggleMobileNav()" class="btn btn-link p-1 text-decoration-none">
					<i class="bi bi-list fs-4"></i>
				</button>
				<span class="fw-semibold">AI Chatbot</span>
				<button onclick="createNewChat()" class="btn btn-link p-1 text-decoration-none">
					<i class="bi bi-plus-lg fs-5"></i>
				</button>
			</div>

			<!-- Mobile Nav Overlay -->
			<div id="mobile-nav-overlay" onclick="toggleMobileNav()"
				class="d-md-none position-fixed top-0 start-0 w-100 h-100 bg-black bg-opacity-50"
				style="z-index: 30; opacity: 0; pointer-events: none;"></div>

			<!-- Mobile Nav Drawer -->
			<div id="mobile-nav"
				class="d-md-none position-fixed top-0 start-0 h-100 bg-white dark bg-dark d-flex flex-column"
				style="width: 280px; z-index: 40; transform: translateX(-100%); transition: transform 0.3s ease;">
				<!-- Clone of sidebar content for mobile -->
				<div class="p-3 border-bottom border-secondary d-flex align-items-center justify-content-between">
					<span class="fw-bold fs-5">Menu</span>
					<button onclick="toggleMobileNav()" class="btn btn-link p-1 text-decoration-none">
						<i class="bi bi-x-lg"></i>
					</button>
				</div>
				<div class="flex-grow-1 overflow-auto p-2" id="mobile-nav-content">
					<!-- Content injected via JS -->
				</div>
			</div>

			<!-- Main Content Area -->
			<main class="d-flex flex-column h-100 w-100 overflow-hidden pt-5 pt-md-0">
				<!-- Chat Window -->
				<div id="chat-container" class="flex-grow-1 overflow-auto scrollbar-custom">
					<div class="container-fluid h-100 d-flex flex-column justify-content-center align-items-center px-4 py-4"
						style="max-width: 768px; margin: 0 auto;">

						<!-- Welcome / Empty State -->
						<div id="welcome-screen" class="text-center">
							<div class="card border-0 shadow-sm mb-4 bg-body-tertiary dark bg-dark">
								<div class="card-body p-4">
									<svg class="bi text-dark mx-auto mb-3" width="48" height="48" viewBox="0 0 32 32"
										fill="currentColor" xmlns="http://www.w3.org/2000/svg">
										<path
											d="M16.0006 25.9992C13.8266 25.999 11.7118 25.2901 9.97686 23.9799C8.2419 22.6698 6.98127 20.8298 6.38599 18.7388C5.79071 16.6478 5.89323 14.4198 6.678 12.3923C7.46278 10.3648 8.88705 8.64837 10.735 7.50308C12.5829 6.35779 14.7538 5.84606 16.9187 6.04544C19.0837 6.24481 21.1246 7.14442 22.7323 8.60795C24.34 10.0715 25.4268 12.0192 25.8281 14.1559C26.2293 16.2926 25.9232 18.5019 24.9561 20.449C24.7703 20.8042 24.7223 21.2155 24.8211 21.604L25.4211 23.8316C25.4803 24.0518 25.4805 24.2837 25.4216 24.5039C25.3627 24.7242 25.2468 24.925 25.0856 25.0862C24.9244 25.2474 24.7235 25.3633 24.5033 25.4222C24.283 25.4811 24.0512 25.4809 23.831 25.4217L21.6034 24.8217C21.2172 24.7248 20.809 24.7729 20.4558 24.9567C19.0683 25.6467 17.5457 26.0068 16.0006 26.0068V25.9992Z" />
									</svg>
								</div>
							</div>
							<h1 class="h2 fw-bold mb-3">AI Chatbot</h1>
							<p class="text-muted mb-4">Powered by Unified AI Router - Making the community's best AI chat
								models available to everyone.</p>
							<button onclick="startNewConversation()" class="btn btn-primary">
								Start New Conversation
							</button>
						</div>

						<!-- Messages -->
						<div id="messages-list" class="w-100 d-flex flex-column gap-3">
						</div>
					</div>
				</div>

				<!-- Input Area -->
				<div class="position-absolute bottom-0 start-0 w-100 bg-gradient bg-body"
					style="background: linear-gradient(to top, var(--bs-body-bg), transparent); padding: 2.5rem 1rem 1rem;">
					<div class="container-fluid" style="max-width: 768px; margin: 0 auto;">
						<div class="card border-0 shadow-sm">
							<div class="card-body p-3">
								<div class="d-flex align-items-end gap-2">
									<!-- Attach Button -->
									<button
										class="btn btn-outline-secondary btn-sm rounded-circle d-flex align-items-center justify-content-center"
										style="width: 40px; height: 40px;" title="Attach file">
										<i class="bi bi-paperclip"></i>
									</button>

									<!-- Textarea -->
									<textarea id="chat-input" rows="1" class="form-control border-0 bg-transparent resize-none"
										placeholder="Ask anything..." style="min-height: 44px; max-height: 150px;"></textarea>

									<!-- Send Button -->
									<button id="send-btn"
										class="btn btn-primary btn-sm rounded-circle d-flex align-items-center justify-content-center"
										style="width: 40px; height: 40px;" disabled>
										<i class="bi bi-send-fill"></i>
									</button>
								</div>
							</div>
						</div>
						<div class="text-center mt-2">
							<small class="text-muted">AI generated content may be inaccurate.</small>
						</div>
					</div>
				</div>

			</main>
		</div>
	</div>

	<!-- Settings Modal -->
	<div id="settings-modal" class="modal fade" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-dialog-centered">
			<div class="modal-content bg-body-tertiary dark bg-dark">
				<div class="modal-header">
					<h5 class="modal-title" id="settingsModalLabel">Settings</h5>
					<button type="button" class="btn-close" onclick="closeSettings()" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="mb-3">
						<label for="model-select" class="form-label">Model</label>
						<select id="model-select" class="form-select">
							<option value="">Auto-select (Recommended)</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="temperature-slider" class="form-label">Temperature</label>
						<input type="range" id="temperature-slider" class="form-range" min="0" max="2" step="0.1" value="0.7">
						<div class="form-text">Value: <span id="temperature-value">0.7</span></div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" onclick="closeSettings()">Cancel</button>
					<button type="button" class="btn btn-primary" onclick="saveSettings()">Save</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Marked.js for Markdown parsing -->
	<script src="marked.umd.js"></script>
	<!-- Bootstrap JS -->
	<script src="bootstrap-5.3.8-dist/js/bootstrap.bundle.min.js"></script>

	<script>
		// --- State Management ---
		let conversations = JSON.parse(localStorage.getItem('chatbot-conversations') || '[]');
		let currentConversation = null;
		let isTyping = false;

		// --- API Configuration ---
		const API_BASE = window.location.origin;

		// --- Theme Management ---
		function toggleTheme() {
			const html = document.documentElement;
			if (html.classList.contains('dark')) {
				html.classList.remove('dark');
				localStorage.setItem('theme', 'light');
			} else {
				html.classList.add('dark');
				localStorage.setItem('theme', 'dark');
			}
		}

		// Initialize Theme
		if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
			document.documentElement.classList.add('dark');
		}

		// --- Mobile Navigation ---
		const mobileNav = document.getElementById('mobile-nav');
		const mobileOverlay = document.getElementById('mobile-nav-overlay');

		function toggleMobileNav() {
			const isClosed = mobileNav.style.transform === 'translateX(-100%)';
			if (isClosed) {
				mobileNav.style.transform = 'translateX(0)';
				mobileOverlay.style.pointerEvents = 'auto';
				mobileOverlay.style.opacity = '1';
			} else {
				mobileNav.style.transform = 'translateX(-100%)';
				mobileOverlay.style.pointerEvents = 'none';
				mobileOverlay.style.opacity = '0';
			}
		}

		// --- Conversation Management ---
		function createNewChat() {
			currentConversation = {
				id: Date.now(),
				title: 'New Chat',
				messages: [],
				created: new Date().toISOString()
			};
			conversations.unshift(currentConversation);
			saveConversations();
			renderConversationList();
			loadConversation(currentConversation.id);
		}

		function loadConversation(id) {
			currentConversation = conversations.find(c => c.id === id);
			if (!currentConversation) return;

			renderMessages();
			updateMobileNavContent();
		}

		function saveConversations() {
			localStorage.setItem('chatbot-conversations', JSON.stringify(conversations));
		}

		function renderConversationList() {
			const container = document.getElementById('conversation-list');
			if (conversations.length === 0) {
				container.innerHTML = '<div class="text-muted small p-2">No conversations yet</div>';
				return;
			}

			container.innerHTML = conversations.map(conv => `
                <div class="d-flex align-items-center gap-2 p-2 rounded ${currentConversation && currentConversation.id === conv.id ? 'bg-primary bg-opacity-10' : 'hover-bg'}">
                    <a href="#" class="flex-grow-1 text-decoration-none small ${currentConversation && currentConversation.id === conv.id ? 'fw-semibold' : 'text-muted'}" onclick="loadConversation(${conv.id})">
                        <div class="text-truncate">${conv.title}</div>
                    </a>
                    <button onclick="deleteConversation(${conv.id}); event.stopPropagation();" class="btn btn-link btn-sm p-1 text-danger">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
		}

		function deleteConversation(id) {
			conversations = conversations.filter(c => c.id !== id);
			if (currentConversation && currentConversation.id === id) {
				currentConversation = conversations[0] || null;
				if (currentConversation) {
					loadConversation(currentConversation.id);
				} else {
					clearChat();
				}
			}
			saveConversations();
			renderConversationList();
		}

		function startNewConversation() {
			createNewChat();
			document.getElementById('welcome-screen').classList.add('d-none');
			document.getElementById('chat-input').focus();
		}

		function clearChat() {
			document.getElementById('messages-list').innerHTML = '';
			document.getElementById('welcome-screen').classList.remove('d-none');
		}

		// --- Message Management ---
		function addMessage(content, role) {
			if (!currentConversation) return;

			const message = {
				id: Date.now(),
				role: role,
				content: content,
				timestamp: new Date().toISOString()
			};

			currentConversation.messages.push(message);

			// Update conversation title for user messages
			if (role === 'user' && currentConversation.messages.filter(m => m.role === 'user').length === 1) {
				currentConversation.title = content.substring(0, 50) + (content.length > 50 ? '...' : '');
			}

			saveConversations();
			renderMessages();
		}

		function renderMessages() {
			const container = document.getElementById('messages-list');
			const welcome = document.getElementById('welcome-screen');

			if (!currentConversation || currentConversation.messages.length === 0) {
				welcome.classList.remove('d-none');
				container.innerHTML = '';
				return;
			}

			welcome.classList.add('d-none');

			container.innerHTML = currentConversation.messages.map(msg => {
				if (msg.role === 'user') {
					return `
                    <div class="d-flex justify-content-end w-100">
                        <div class="chat-message bg-primary text-white rounded-3 p-3">
                            <div class="small">${escapeHtml(msg.content)}</div>
                        </div>
                    </div>`;
				} else {
					return `
                    <div class="d-flex align-items-start gap-3 w-100">
                        <div class="flex-shrink-0">
                            <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                                <small class="fw-bold">AI</small>
                            </div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body">
                                    <div class="markdown-content">
                                        ${renderMarkdown(msg.content)}
                                    </div>
                                    <!-- Footer Actions -->
                                    <div class="d-flex gap-2 mt-2 opacity-0 transition-opacity" style="transition: opacity 0.2s;">
                                        <button onclick="copyMessage('${msg.id}')" class="btn btn-link btn-sm p-1 text-muted" title="Copy">
                                            <i class="bi bi-clipboard"></i>
                                        </button>
                                        <button onclick="regenerateResponse()" class="btn btn-link btn-sm p-1 text-muted" title="Regenerate">
                                            <i class="bi bi-arrow-clockwise"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
				}
			}).join('');

			// Add hover effects for action buttons
			container.querySelectorAll('.card').forEach(card => {
				card.addEventListener('mouseenter', () => {
					const actions = card.querySelector('.opacity-0');
					if (actions) actions.style.opacity = '1';
				});
				card.addEventListener('mouseleave', () => {
					const actions = card.querySelector('.opacity-0:not(.show)');
					if (actions) actions.style.opacity = '0';
				});
			});

			// Scroll to bottom
			const scrollContainer = document.getElementById('chat-container');
			scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
		}

		function renderMarkdown(content) {
			// Configure marked options for better output
			marked.setOptions({
				breaks: true,
				gfm: true
			});
			return marked.parse(content);
		}

		function copyMessage(messageId) {
			const message = currentConversation.messages.find(m => m.id == messageId);
			if (message && message.role === 'assistant') {
				navigator.clipboard.writeText(message.content).then(() => {
					// Show brief feedback
					const button = event.target.closest('button');
					const originalTitle = button.title;
					button.title = 'Copied!';
					button.classList.add('text-success');
					setTimeout(() => {
						button.title = originalTitle;
						button.classList.remove('text-success');
					}, 1000);
				});
			}
		}

		// --- API Communication ---
		async function sendMessage() {
			const textarea = document.getElementById('chat-input');
			const text = textarea.value.trim();
			if (!text || isTyping) return;

			// Auto-create conversation if none exists
			if (!currentConversation) {
				createNewChat();
			}

			// Add user message
			addMessage(text, 'user');

			// Clear input
			textarea.value = '';
			textarea.style.height = 'auto';
			document.getElementById('send-btn').setAttribute('disabled', 'true');

			// Show typing indicator
			showTypingIndicator();

			try {
				const response = await fetch(`${API_BASE}/v1/chat/completions`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify({
						messages: currentConversation.messages.map(m => ({
							role: m.role,
							content: m.content
						})),
						model: document.getElementById('model-select').value || undefined,
						temperature: parseFloat(document.getElementById('temperature-slider').value),
						stream: false
					})
				});

				if (!response.ok) {
					throw new Error(`HTTP error! status: ${response.status}`);
				}

				const data = await response.json();
				const assistantMessage = data.choices[0]?.message?.content || 'Sorry, I couldn\'t generate a response.';

				hideTypingIndicator();
				addMessage(assistantMessage, 'assistant');

			} catch (error) {
				console.error('Error sending message:', error);
				hideTypingIndicator();
				addMessage(`Error: ${error.message}`, 'assistant');
			}
		}

		function showTypingIndicator() {
			isTyping = true;
			const container = document.getElementById('messages-list');
			const typingHtml = `
                <div class="d-flex align-items-start gap-3 w-100" id="typing-indicator">
                    <div class="flex-shrink-0">
                        <div class="rounded-circle bg-dark d-flex align-items-center justify-content-center text-white" style="width: 40px; height: 40px;">
                            <small class="fw-bold">AI</small>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="typing-indicator text-muted">
                                    <span>AI is thinking</span>
                                    <div class="d-flex align-items-center gap-1 ms-2">
                                        <div class="rounded-circle bg-secondary typing-dot" style="width: 8px; height: 8px;"></div>
                                        <div class="rounded-circle bg-secondary typing-dot" style="width: 8px; height: 8px;"></div>
                                        <div class="rounded-circle bg-secondary typing-dot" style="width: 8px; height: 8px;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
			container.insertAdjacentHTML('beforeend', typingHtml);

			// Scroll to bottom
			const scrollContainer = document.getElementById('chat-container');
			scrollContainer.scrollTo({ top: scrollContainer.scrollHeight, behavior: 'smooth' });
		}

		function hideTypingIndicator() {
			isTyping = false;
			const typingIndicator = document.getElementById('typing-indicator');
			if (typingIndicator) {
				typingIndicator.remove();
			}
		}

		function regenerateResponse() {
			if (currentConversation && currentConversation.messages.length > 0) {
				// Remove the last assistant message
				for (let i = currentConversation.messages.length - 1; i >= 0; i--) {
					if (currentConversation.messages[i].role === 'assistant') {
						currentConversation.messages.splice(i, 1);
						break;
					}
				}

				// Get the last user message
				const lastUserMessage = currentConversation.messages.filter(m => m.role === 'user').pop();
				if (lastUserMessage) {
					// Remove the last user message and resend
					for (let i = currentConversation.messages.length - 1; i >= 0; i--) {
						if (currentConversation.messages[i].id === lastUserMessage.id) {
							currentConversation.messages.splice(i, 1);
							break;
						}
					}

					renderMessages();
					// Resend the message
					document.getElementById('chat-input').value = lastUserMessage.content;
					sendMessage();
				}
			}
		}

		// --- Settings Management ---
		function showSettings() {
			const modal = new bootstrap.Modal(document.getElementById('settings-modal'));
			modal.show();
		}

		function closeSettings() {
			const modal = bootstrap.Modal.getInstance(document.getElementById('settings-modal'));
			if (modal) {
				modal.hide();
			}
		}

		function saveSettings() {
			// Settings are automatically saved through the form values
			closeSettings();
		}

		// --- Utility Functions ---
		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function updateMobileNavContent() {
			const sidebarContent = document.querySelector('#sidebar .flex-grow-1').innerHTML;
			document.getElementById('mobile-nav-content').innerHTML = sidebarContent;
		}

		// --- Event Listeners ---
		// Auto-resize Textarea
		const textarea = document.getElementById('chat-input');
		const sendBtn = document.getElementById('send-btn');

		textarea.addEventListener('input', function () {
			this.style.height = 'auto';
			this.style.height = (this.scrollHeight) + 'px';

			if (this.value.trim().length > 0 && !isTyping) {
				sendBtn.removeAttribute('disabled');
			} else {
				sendBtn.setAttribute('disabled', 'true');
			}
		});

		// Send Message Events
		sendBtn.addEventListener('click', sendMessage);
		textarea.addEventListener('keydown', (e) => {
			if (e.key === 'Enter' && !e.shiftKey) {
				e.preventDefault();
				sendMessage();
			}
		});

		// Temperature slider
		document.getElementById('temperature-slider').addEventListener('input', function () {
			document.getElementById('temperature-value').textContent = this.value;
		});

		// --- Initialization ---
		function init() {
			renderConversationList();

			// Load most recent conversation if exists
			if (conversations.length > 0) {
				loadConversation(conversations[0].id);
			}
		}

		// Initialize the app
		init();
	</script>
</body>

</html>